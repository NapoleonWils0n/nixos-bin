#!/bin/sh

#===============================================================================
# sox calculate decibel levels for deep-filternet
#===============================================================================

# dependencies:
# sox, awk

#===============================================================================
# script usage
#===============================================================================

usage () {
# if argument passed to function echo it
[ -z "${1}" ] || echo "! ${1}"
# display help
echo "\
$(basename "$0") -i input.wav"
exit 2
}


#===============================================================================
# error messages
#===============================================================================

INVALID_OPT_ERR='Invalid option:'
REQ_ARG_ERR='requires an argument'
WRONG_ARGS_ERR='wrong number of arguments passed to script'


#===============================================================================
# check the number of arguments passed to the script
#===============================================================================

[ $# -gt 0 ] || usage "${WRONG_ARGS_ERR}"


#===============================================================================
# getopts check the options passed to the script
#===============================================================================

while getopts ':i:h' opt
do
  case ${opt} in
     i) input="${OPTARG}";;
     h) usage;;
     \?) usage "${INVALID_OPT_ERR} ${OPTARG}" 1>&2;;
     :) usage "${INVALID_OPT_ERR} ${OPTARG} ${REQ_ARG_ERR}" 1>&2;;
  esac
done
shift $((OPTIND-1))


#===============================================================================
# decibel function
#===============================================================================

decibel() {
  # 2>&1 is vital because sox prints stats to stderr
  sox "${input}" -n stats 2>&1 | awk -v file="${input}" '
    # Function to grab the first number (Peak/RMS/Trough) on the line
    function get_db(str) {
        for (i=1; i<=NF; i++) {
            if ($i ~ /^-?[0-9.]+$/) return $i
        }
        return 0
    }

    /Pk lev dB/  { peak = get_db($0) }
    /RMS lev dB/ { rms = get_db($0) }
    /RMS Tr dB/  { trough = get_db($0) }

    END {
      # If rms is still 0, something went wrong with the sox pipe
      if (rms == 0) {
        print "Error: Could not extract stats. Ensure sox is installed and the file is a valid audio file."
        exit 1
      }

      # Calculations
      thresh = rms - 12;
      gap = rms - trough;
      atten = (gap > 30) ? 15 : 10;

      printf "\n--- Decibel Statistics ---\n"
      printf "File:          %s\n", file
      printf "Peak Level:    %s dB\n", peak
      printf "RMS Level:     %s dB (Average)\n", rms
      printf "Noise Floor:   %s dB (Trough)\n", trough
      printf "Signal Gap:    %.2f dB\n\n", gap

      # 2. Deep-filter settings Section
      printf "--- deep-filter settings ---\n"
      printf "atten-lim-db:  --atten-lim-db %d\n", atten
      printf "min-db-thresh: --min-db-thresh %.0f\n", thresh
    }
  '
}


#===============================================================================
# run decibel function
#===============================================================================

decibel
